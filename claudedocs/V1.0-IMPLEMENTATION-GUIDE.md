# V1.0 Complete Implementation Guide
## Systematic Implementation of ALL Features

**Status**: Core infrastructure complete, now implementing all strategies and features

---

## ‚úÖ COMPLETED Components

### Configuration Layer
- ‚úÖ `ext_conf_template.txt` - Extension Manager configuration with all options
- ‚úÖ `Classes/Configuration/ExtensionConfiguration.php` - Type-safe config management

### Domain Layer
- ‚úÖ `Classes/Domain/Model/TemporalContent.php` - Immutable value object
- ‚úÖ `Classes/Domain/Model/TransitionEvent.php` - Transition event value object

### Service Interfaces
- ‚úÖ `Classes/Service/Scoping/ScopingStrategyInterface.php` - Scoping strategy contract
- ‚úÖ `Classes/Service/Timing/TimingStrategyInterface.php` - Timing strategy contract

---

## üîÑ REMAINING Implementation Tasks

### Task 1: Core Service Layer
**Priority: CRITICAL** - These enable all features

#### 1A: RefindexService (Foundation for per-content scoping)
**File**: `Classes/Service/RefindexService.php`
```php
class RefindexService {
    // Find all pages where a content element appears
    public function findPagesWithContent(int $contentUid, int $languageUid): array
    // Query sys_refindex for references
    // Check mount points and shortcuts
    // Return array of page UIDs
}
```

#### 1B: HarmonizationService (Time slot rounding)
**File**: `Classes/Service/HarmonizationService.php`
```php
class HarmonizationService {
    public function harmonizeTimestamp(int $timestamp): int
    // Round to nearest configured slot within tolerance
    public function getSlotsInRange(int $start, int $end): array
    // Get all slots for timeline visualization
}
```

#### 1C: TemporalContentRepository
**File**: `Classes/Domain/Repository/TemporalContentRepository.php`
```php
class TemporalContentRepository {
    public function findAllWithTemporalFields(): array
    // Find all pages and content with starttime/endtime
    public function findTransitionsInRange(int $start, int $end): array
    // Find transitions for scheduler
    public function countTransitionsPerDay(): int
    // Statistics for dashboard
}
```

### Task 2: Scoping Strategy Implementations
**Priority: HIGH** - Core cache optimization

#### 2A: GlobalScopingStrategy (Phase 1 behavior - BACKWARD COMPAT)
**File**: `Classes/Service/Scoping/GlobalScopingStrategy.php`
- Returns `['pages']` tag (flushes ALL pages)
- Exact Phase 1 behavior for backward compatibility

#### 2B: PerPageScopingStrategy
**File**: `Classes/Service/Scoping/PerPageScopingStrategy.php`
- For pages: `['pageId_X']`
- For content: `['pageId_' . $content->pid]`

#### 2C: PerContentScopingStrategy ‚≠ê **KEY FEATURE**
**File**: `Classes/Service/Scoping/PerContentScopingStrategy.php`
- Uses RefindexService to find all affected pages
- Returns `['pageId_X', 'pageId_Y', ...]` - only affected pages
- This achieves the 99.7% cache reduction!

### Task 3: Timing Strategy Implementations
**Priority: HIGH** - Flexible timing options

#### 3A: DynamicTimingStrategy (Phase 1 behavior)
**File**: `Classes/Service/Timing/DynamicTimingStrategy.php`
- Event-based (runs on every page generation)
- Calculates cache lifetime from next transition

#### 3B: SchedulerTimingStrategy
**File**: `Classes/Service/Timing/SchedulerTimingStrategy.php`
- Returns null for getCacheLifetime (caches live indefinitely)
- Process transitions in processTransition() method
- Called by scheduler task

#### 3C: HybridTimingStrategy
**File**: `Classes/Service/Timing/HybridTimingStrategy.php`
- Delegates based on content type (pages vs content)
- Configurable rules from ExtensionConfiguration

### Task 4: Scheduler Integration
**Priority: MEDIUM** - Required for scheduler/hybrid strategies

#### 4A: TemporalCacheSchedulerTask
**File**: `Classes/Task/TemporalCacheSchedulerTask.php`
- Extends AbstractTask
- Finds transitions since last run
- Processes via timing strategy

#### 4B: Task Configuration
**File**: `Configuration/TCA/tx_scheduler_task.php` (if needed)

### Task 5: Backend Module
**Priority: MEDIUM** - User management interface

#### 5A: Controller
**File**: `Classes/Controller/Backend/TemporalCacheController.php`
- dashboardAction() - Statistics and timeline
- contentAction() - List all temporal content
- wizardAction() - Configuration wizard
- harmonizeAction() - Apply bulk harmonization

#### 5B: Module Registration
**Files**:
- `Configuration/Backend/Routes.php`
- `Configuration/Backend/Modules.php`

#### 5C: Templates
**Files**:
- `Resources/Private/Templates/Backend/TemporalCache/Dashboard.html`
- `Resources/Private/Templates/Backend/TemporalCache/Content.html`
- `Resources/Private/Templates/Backend/TemporalCache/Wizard.html`

#### 5D: Language Files
**File**: `Resources/Private/Language/locallang_mod.xlf`

### Task 6: Update EventListener
**Priority: CRITICAL** - Integrate strategies

**File**: `Classes/EventListener/TemporalCacheLifetime.php`
- Inject ExtensionConfiguration
- Inject ScopingStrategy (based on config)
- Inject TimingStrategy (based on config)
- Use strategies instead of direct implementation

### Task 7: Dependency Injection Configuration
**Priority: CRITICAL** - Wire everything together

**File**: `Configuration/Services.yaml`
- Register all services
- Configure strategy factories
- Set up conditional service selection based on config

### Task 8: Unit Tests
**Priority: HIGH** - Quality assurance

**Files** (15+ test classes):
- `Tests/Unit/Configuration/ExtensionConfigurationTest.php`
- `Tests/Unit/Domain/Model/TemporalContentTest.php`
- `Tests/Unit/Domain/Model/TransitionEventTest.php`
- `Tests/Unit/Service/Scoping/*Test.php` (all strategies)
- `Tests/Unit/Service/Timing/*Test.php` (all strategies)
- `Tests/Unit/Service/HarmonizationServiceTest.php`
- `Tests/Unit/Service/RefindexServiceTest.php`

### Task 9: Functional Tests
**Priority: MEDIUM** - Integration testing

**Files** (5+ test classes):
- `Tests/Functional/Service/Scoping/PerContentScopingIntegrationTest.php`
- `Tests/Functional/Service/HarmonizationIntegrationTest.php`
- `Tests/Functional/Task/TemporalCacheSchedulerTaskTest.php`
- `Tests/Functional/Backend/TemporalCacheControllerTest.php`

### Task 10: Documentation Updates
**Priority: HIGH** - User guides

**Files**:
- `README.md` - Add all new features
- `Documentation/Configuration.rst` - NEW - Complete configuration guide
- `Documentation/Backend-Module.rst` - NEW - Backend module guide
- `Documentation/Migration.rst` - NEW - Migration from Phase 1
- `Documentation/Performance-Considerations.rst` - Update with new strategies

---

## Implementation Strategy

### Phase A: Core Services (Enables everything)
1. RefindexService
2. HarmonizationService
3. TemporalContentRepository

### Phase B: Strategies (Core functionality)
1. All Scoping Strategies (Global, PerPage, PerContent)
2. All Timing Strategies (Dynamic, Scheduler, Hybrid)

### Phase C: Integration (Make it work)
1. Update EventListener to use strategies
2. Configure Services.yaml
3. Create Scheduler Task

### Phase D: User Interface (Backend Module)
1. Controller
2. Templates
3. Module registration

### Phase E: Quality Assurance
1. Unit tests for all components
2. Functional tests for integration
3. Documentation updates
4. Conformance validation

---

## Agent Delegation Plan

### Agent 1: backend-architect
- **Task**: Backend module implementation
- **Deliverables**: Controller, templates, routes, module config

### Agent 2: refactoring-expert
- **Task**: Update EventListener to use strategy pattern
- **Deliverables**: Modified EventListener, Services.yaml

### Agent 3: python-expert (for service implementations)
- **Task**: Implement all service classes
- **Deliverables**: Refindex, Harmonization, Repository, all strategies

### Agent 4: quality-engineer
- **Task**: Write comprehensive tests
- **Deliverables**: Unit tests, functional tests

### Agent 5: technical-writer
- **Task**: Update documentation
- **Deliverables**: Updated README, new RST guides

---

## Success Metrics

- ‚úÖ All 40+ files created
- ‚úÖ Zero breaking changes (backward compatible)
- ‚úÖ 85%+ test coverage
- ‚úÖ All tests passing
- ‚úÖ PHPStan level 9 passing
- ‚úÖ PHP-CS-Fixer compliant
- ‚úÖ TYPO3 conformance passing
- ‚úÖ Documentation complete

---

## Next Actions

1. Create core service implementations (RefindexService, HarmonizationService, Repository)
2. Implement all strategy classes
3. Update EventListener and configure DI
4. Build backend module
5. Write tests
6. Update documentation
7. Run quality checks

<html xmlns:f="http://typo3.org/ns/TYPO3/CMS/Fluid/ViewHelpers" data-namespace-typo3-fluid="true">

<f:layout name="Default" />

<f:section name="Content">
    <h1><f:translate key="LLL:EXT:temporal_cache/Resources/Private/Language/locallang_mod.xlf:content.title" /></h1>

    <!-- Filter Bar -->
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="btn-group" role="group">
                <f:for each="{filterOptions}" as="label" key="value">
                    <f:link.action
                        action="content"
                        arguments="{filter: value}"
                        class="btn btn-{f:if(condition: '{filter} == {value}', then: 'primary', else: 'outline-primary')}">
                        <f:translate key="LLL:EXT:temporal_cache/Resources/Private/Language/locallang_mod.xlf:content.{label}" />
                    </f:link.action>
                </f:for>
            </div>

            <f:if condition="{harmonizationEnabled}">
                <div class="float-end">
                    <button
                        type="button"
                        class="btn btn-success"
                        id="harmonize-selected-btn"
                        disabled
                        data-action="harmonize">
                        <f:translate key="LLL:EXT:temporal_cache/Resources/Private/Language/locallang_mod.xlf:content.harmonize_selected" />
                    </button>
                </div>
            </f:if>
        </div>
    </div>

    <!-- Content Table -->
    <f:if condition="{content}">
        <f:then>
            <div class="table-responsive">
                <table class="table table-striped table-hover">
                    <thead>
                        <tr>
                            <f:if condition="{harmonizationEnabled}">
                                <th style="width: 40px;">
                                    <input type="checkbox" id="select-all" class="form-check-input">
                                </th>
                            </f:if>
                            <th><f:translate key="LLL:EXT:temporal_cache/Resources/Private/Language/locallang_mod.xlf:content.table.type" /></th>
                            <th><f:translate key="LLL:EXT:temporal_cache/Resources/Private/Language/locallang_mod.xlf:content.table.uid" /></th>
                            <th><f:translate key="LLL:EXT:temporal_cache/Resources/Private/Language/locallang_mod.xlf:content.table.title" /></th>
                            <th><f:translate key="LLL:EXT:temporal_cache/Resources/Private/Language/locallang_mod.xlf:content.table.start" /></th>
                            <th><f:translate key="LLL:EXT:temporal_cache/Resources/Private/Language/locallang_mod.xlf:content.table.end" /></th>
                            <th><f:translate key="LLL:EXT:temporal_cache/Resources/Private/Language/locallang_mod.xlf:content.table.status" /></th>
                            <f:if condition="{harmonizationEnabled}">
                                <th><f:translate key="LLL:EXT:temporal_cache/Resources/Private/Language/locallang_mod.xlf:content.table.harmonization" /></th>
                            </f:if>
                        </tr>
                    </thead>
                    <tbody>
                        <f:for each="{content}" as="item">
                            <tr class="{f:if(condition: '{item.hasChanges}', then: 'table-warning')}">
                                <f:if condition="{harmonizationEnabled}">
                                    <td>
                                        <f:if condition="{item.hasChanges}">
                                            <input
                                                type="checkbox"
                                                class="form-check-input content-checkbox"
                                                data-uid="{item.content.uid}"
                                                data-table="{item.content.tableName}">
                                        </f:if>
                                    </td>
                                </f:if>
                                <td>
                                    <span class="badge bg-{f:if(condition: '{item.content.tableName} == \'pages\'', then: 'primary', else: 'secondary')}">
                                        {f:if(condition: '{item.content.tableName} == \'pages\'', then: 'Page', else: 'Content')}
                                    </span>
                                </td>
                                <td>{item.content.uid}</td>
                                <td>
                                    <strong>{item.content.title}</strong>
                                    <f:if condition="{item.content.hidden}">
                                        <span class="badge bg-secondary ms-1">hidden</span>
                                    </f:if>
                                </td>
                                <td>
                                    <f:if condition="{item.content.starttime}">
                                        <f:then>
                                            <f:format.date format="d.m.Y H:i">{item.content.starttime}</f:format.date>
                                        </f:then>
                                        <f:else>-</f:else>
                                    </f:if>
                                </td>
                                <td>
                                    <f:if condition="{item.content.endtime}">
                                        <f:then>
                                            <f:format.date format="d.m.Y H:i">{item.content.endtime}</f:format.date>
                                        </f:then>
                                        <f:else>-</f:else>
                                    </f:if>
                                </td>
                                <td>
                                    <f:if condition="{item.content -> f:invoke(method: 'isVisible', arguments: '{0: currentTime}')}">
                                        <f:then>
                                            <span class="badge bg-success"><f:translate key="LLL:EXT:temporal_cache/Resources/Private/Language/locallang_mod.xlf:content.status.active" /></span>
                                        </f:then>
                                        <f:else>
                                            <f:if condition="{item.content.starttime} > {currentTime}">
                                                <f:then>
                                                    <span class="badge bg-primary"><f:translate key="LLL:EXT:temporal_cache/Resources/Private/Language/locallang_mod.xlf:content.status.scheduled" /></span>
                                                </f:then>
                                                <f:else>
                                                    <span class="badge bg-danger"><f:translate key="LLL:EXT:temporal_cache/Resources/Private/Language/locallang_mod.xlf:content.status.expired" /></span>
                                                </f:else>
                                            </f:if>
                                        </f:else>
                                    </f:if>
                                </td>
                                <f:if condition="{harmonizationEnabled}">
                                    <td>
                                        <f:if condition="{item.hasChanges}">
                                            <f:then>
                                                <div class="harmonization-suggestions">
                                                    <f:if condition="{item.suggestions.starttime}">
                                                        <div class="small">
                                                            <strong>Start:</strong>
                                                            <f:format.date format="H:i">{item.suggestions.starttime.suggested}</f:format.date>
                                                            <span class="text-muted">
                                                                (<f:if condition="{item.suggestions.starttime.diff} > 0">+</f:if>{item.suggestions.starttime.diff -> f:format.number(decimals: 0) -> f:variable.divide(divisor: 60)}min)
                                                            </span>
                                                        </div>
                                                    </f:if>
                                                    <f:if condition="{item.suggestions.endtime}">
                                                        <div class="small">
                                                            <strong>End:</strong>
                                                            <f:format.date format="H:i">{item.suggestions.endtime.suggested}</f:format.date>
                                                            <span class="text-muted">
                                                                (<f:if condition="{item.suggestions.endtime.diff} > 0">+</f:if>{item.suggestions.endtime.diff -> f:format.number(decimals: 0) -> f:variable.divide(divisor: 60)}min)
                                                            </span>
                                                        </div>
                                                    </f:if>
                                                </div>
                                            </f:then>
                                            <f:else>
                                                <span class="text-muted">-</span>
                                            </f:else>
                                        </f:if>
                                    </td>
                                </f:if>
                            </tr>
                        </f:for>
                    </tbody>
                </table>
            </div>

            <!-- Pagination -->
            <f:if condition="{pagination.numberOfPages} > 1">
                <nav aria-label="Page navigation">
                    <ul class="pagination justify-content-center">
                        <f:if condition="{pagination.previousPageNumber}">
                            <li class="page-item">
                                <f:link.action
                                    action="content"
                                    arguments="{currentPage: pagination.previousPageNumber, filter: filter}"
                                    class="page-link">
                                    <f:translate key="LLL:EXT:temporal_cache/Resources/Private/Language/locallang_mod.xlf:pagination.previous" />
                                </f:link.action>
                            </li>
                        </f:if>

                        <f:for each="{pagination.pages}" as="page">
                            <li class="page-item {f:if(condition: '{page.isCurrent}', then: 'active')}">
                                <f:link.action
                                    action="content"
                                    arguments="{currentPage: page.number, filter: filter}"
                                    class="page-link">
                                    {page.number}
                                </f:link.action>
                            </li>
                        </f:for>

                        <f:if condition="{pagination.nextPageNumber}">
                            <li class="page-item">
                                <f:link.action
                                    action="content"
                                    arguments="{currentPage: pagination.nextPageNumber, filter: filter}"
                                    class="page-link">
                                    <f:translate key="LLL:EXT:temporal_cache/Resources/Private/Language/locallang_mod.xlf:pagination.next" />
                                </f:link.action>
                            </li>
                        </f:if>
                    </ul>
                </nav>
            </f:if>

        </f:then>
        <f:else>
            <div class="alert alert-info">
                <f:translate key="LLL:EXT:temporal_cache/Resources/Private/Language/locallang_mod.xlf:content.no_content" />
            </div>
        </f:else>
    </f:if>

</f:section>

<f:section name="FooterAssets">
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const selectAllCheckbox = document.getElementById('select-all');
            const contentCheckboxes = document.querySelectorAll('.content-checkbox');
            const harmonizeBtn = document.getElementById('harmonize-selected-btn');

            if (selectAllCheckbox) {
                selectAllCheckbox.addEventListener('change', function() {
                    contentCheckboxes.forEach(checkbox => {
                        checkbox.checked = this.checked;
                    });
                    updateHarmonizeButton();
                });
            }

            contentCheckboxes.forEach(checkbox => {
                checkbox.addEventListener('change', updateHarmonizeButton);
            });

            function updateHarmonizeButton() {
                const checkedCount = document.querySelectorAll('.content-checkbox:checked').length;
                if (harmonizeBtn) {
                    harmonizeBtn.disabled = checkedCount === 0;
                    harmonizeBtn.textContent = checkedCount > 0
                        ? `Harmonize ${checkedCount} selected`
                        : 'Harmonize selected';
                }
            }

            if (harmonizeBtn) {
                harmonizeBtn.addEventListener('click', function() {
                    const selectedUids = Array.from(document.querySelectorAll('.content-checkbox:checked'))
                        .map(cb => cb.dataset.uid);

                    if (selectedUids.length === 0) {
                        return;
                    }

                    if (!confirm(`Harmonize ${selectedUids.length} content elements?`)) {
                        return;
                    }

                    fetch('/typo3/temporal-cache/harmonize', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            content: selectedUids,
                            dryRun: false
                        })
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            alert(data.message);
                            location.reload();
                        } else {
                            alert('Error: ' + data.message);
                        }
                    })
                    .catch(error => {
                        alert('Error: ' + error.message);
                    });
                });
            }
        });
    </script>
</f:section>

</html>
